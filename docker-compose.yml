services:
  # =============================================================================
  # Vault (dev) - HashiCorp Vault server
  # =============================================================================

  #NO_VAULT: commenting the vault container
#  vault-service:
#    image: hashicorp/vault:1.14.0
#    container_name: vault_service
#    cap_add:
#      - IPC_LOCK
#    ports:
#      - "8200:8200"
#    env_file:
#      - .env
#    environment:
#    - VAULT_TOKEN=${VAULT_TOKEN:-}
#    volumes:
#      - ./vault:/vault/config
#      - ./vault/data:/vault/file
#    command:
#      - "server"
#    restart: unless-stopped
#    networks:
#      - ft_transcendence_network
#    healthcheck:
#      test: ["CMD-SHELL", "curl -sSf http://127.0.0.1:8200/v1/sys/health || exit 0"]
#      interval: 10s
#      timeout: 5s
#      retries: 20

  # =============================================================================
  # BACKEND SERVICES
  # =============================================================================

  # User Service
  user-service:
    build:
      context: ./backend/user-service
      dockerfile: Dockerfile
    container_name: user_service
    env_file:
      - .env
    environment:
      - USER_SERVICE_PORT=${USER_SERVICE_PORT}
      - USER_SERVICE_URL=${USER_SERVICE_URL}
      - USER_DATABASE_URL=${USER_DATABASE_URL}
      - NODE_ENV=${NODE_ENV}
      - VAULT_TOKEN=${VAULT_TOKEN:-}
    expose:
      - "${USER_SERVICE_PORT}"
    volumes:
      - user_data:/app/data
# NO_VAULT: removing the Vault dependence
#    depends_on:
#      vault-service:
#        condition: service_healthy
    networks:
      - ft_transcendence_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${USER_SERVICE_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Auth Service
  auth-service:
    build:
      context: ./backend/auth-service
      dockerfile: Dockerfile
    container_name: auth_service
    env_file:
      - .env
    environment:
      - AUTH_SERVICE_PORT=${AUTH_SERVICE_PORT}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - AUTH_DATABASE_URL=${AUTH_DATABASE_URL}
      - USER_SERVICE_URL=http://user_service:${USER_SERVICE_PORT}
      - NODE_ENV=${NODE_ENV}
      - VAULT_TOKEN=${VAULT_TOKEN:-}
    expose:
      - "${AUTH_SERVICE_PORT}"
    volumes:
      - auth_data:/app/data
    depends_on:
# NO_VAULT: removing the Vault dependence
#      vault-service:
#        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - ft_transcendence_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${AUTH_SERVICE_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Gateway Service
  gateway-service:
    build:
      context: ./backend/gateway
      dockerfile: Dockerfile
    container_name: gateway_service
    env_file:
      - .env
    environment:
      - GATEWAY_PORT=${GATEWAY_PORT}
      - GATEWAY_URL=${GATEWAY_URL}
      - AUTH_SERVICE_URL=http://auth_service:${AUTH_SERVICE_PORT}
      - USER_SERVICE_URL=http://user_service:${USER_SERVICE_PORT}
      - WS_SERVICE_URL=http://ws_service:${WS_PORT}
      - NODE_ENV=${NODE_ENV}
      - VAULT_TOKEN=${VAULT_TOKEN:-}
    expose:
      - "${GATEWAY_PORT}"
    depends_on:
# NO_VAULT: removing the Vault dependence
#      vault-service:
#        condition: service_healthy
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - ft_transcendence_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${GATEWAY_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # WebSocket Service
  ws-service:
    build:
      context: ./backend/ws-service
      dockerfile: Dockerfile
    container_name: ws_service
    env_file:
      - .env
    environment:
      - WS_PORT=${WS_PORT}
      - WS_SERVICE_URL=${WS_SERVICE_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - GATEWAY_URL=http://gateway_service:${GATEWAY_PORT}
      - AUTH_SERVICE_URL=http://auth_service:${AUTH_SERVICE_PORT}
      - USER_SERVICE_URL=http://user_service:${USER_SERVICE_PORT}
      - NODE_ENV=${NODE_ENV}
      - VAULT_TOKEN=${VAULT_TOKEN:-}
    expose:
      - "${WS_PORT}"
    depends_on:
# NO_VAULT: removing the Vault dependence
#      vault-service:
#        condition: service_healthy
      auth-service:
        condition: service_healthy
      user-service:
        condition: service_healthy
      gateway-service:
        condition: service_healthy
    networks:
      - ft_transcendence_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${WS_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =============================================================================
  # ELK STACK SERVICES
  # =============================================================================

  # Elasticsearch - Log storage and indexing
  elasticsearch:
    image: elasticsearch:7.17.9
    container_name: elasticsearch
    env_file:
      - .env
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=true
      - xpack.license.self_generated.type=basic
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    # No ports exposed - access only through nginx at https://LAN_IP/elasticsearch/
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - ft_transcendence_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -u elastic:${ELASTIC_PASSWORD:-changeme} -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Logstash - Log processing and transformation
  logstash:
    image: logstash:7.17.9
    container_name: logstash
    env_file:
      - .env
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
      - XPACK_MONITORING_ENABLED=false
      - ELASTICSEARCH_USER=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD:-changeme}
      - HTTP_PORT=9600
    ports:
      - "${LOGSTASH_PORT:-5044}:5044"
    volumes:
      - ./backend/logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf:ro
      - logstash_data:/usr/share/logstash/data
    networks:
      - ft_transcendence_network
    depends_on:
      elasticsearch:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9600/_node/stats || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Filebeat - Log collection from Docker containers
  filebeat:
    image: elastic/filebeat:7.17.9
    container_name: filebeat
    user: root
    env_file:
      - .env
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
    volumes:
      - ./backend/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - ft_transcendence_network
    depends_on:
      logstash:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f filebeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Kibana - Log visualization and dashboards
  kibana:
    image: kibana:7.17.9
    container_name: kibana
    # No ports exposed - access only through nginx at https://LAN_IP/kibana/
    env_file:
      - .env
    networks:
      - ft_transcendence_network
    depends_on:
      elasticsearch:
        condition: service_healthy
    volumes:
      # Mount Kibana configuration file
      - ./backend/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml:ro
      # Mount folder with setup-script and dashboard-export
      - ./backend/kibana:/usr/share/kibana/elk-setup
      # (this folder will contain elk-setup.sh, dashboard-import-with-id.ndjson, ilm-policy.json)
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -u elastic:${ELASTIC_PASSWORD:-changeme} -f http://localhost:5601/kibana/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Kibana Setup - Automatically creates index patterns and imports dashboards
  kibana-setup:
    image: curlimages/curl:latest
    container_name: kibana_setup
    env_file:
      - .env
    networks:
      - ft_transcendence_network
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_healthy
    volumes:
      - ./backend/kibana:/elk-setup:ro
    environment:
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD:-changeme}
    entrypoint: ["/bin/sh"]
    command: ["/elk-setup/elk-setup.sh"]
    restart: "no"


  # =============================================================================
  # FRONTEND SERVICE
  # =============================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_BACKEND_URL=${VITE_BACKEND_URL:-https://${LAN_IP}/api}
        - VITE_WS_URL=${VITE_WS_URL:-wss://${LAN_IP}/ws}
    container_name: frontend_service
    env_file:
      - .env
    environment:
      - FRONTEND_PORT=${FRONTEND_PORT}
    expose:
      - "${FRONTEND_PORT}"
    depends_on:
      gateway-service:
        condition: service_healthy
      ws-service:
        condition: service_healthy
    networks:
      - ft_transcendence_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${FRONTEND_PORT}/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# =============================================================================
  # PROXY SERVICE
 # =============================================================================
  waf:
    build:
      context: ./waf
      dockerfile: Dockerfile
    container_name: waf_service
    ports:
      - "80:80"
      - "443:443"
    env_file:
      - .env
    environment:
      VAULT_ADDR: http://vault-service:8200
      VAULT_TOKEN: ${VAULT_TOKEN:-}
    volumes:
      - ./waf/modsec_logs:/var/log/modsec
      - ./waf/nginx_logs:/var/log/nginx
      - ./waf/nginx.conf:/etc/nginx/templates/conf.d/default.conf.template:ro
      - ./waf/modsecurity.conf:/etc/nginx/templates/modsecurity.d/setup.conf.template:ro
      - ./waf/crs:/etc/nginx/modsec/crs:ro
      - ./waf/exception-rules.conf:/etc/nginx/modsec/exception-rules.conf:ro
      # NO_VAUT: adding the local certs to volume:
      - ./waf/certs:/etc/nginx/certs:ro
    depends_on:
# NO_VAULT: removing the Vault dependence
#     vault-service:
#       condition: service_healthy
      gateway-service:
        condition: service_healthy
      ws-service:
        condition: service_healthy
      frontend:
        condition: service_healthy
    networks:
      - ft_transcendence_network
    restart: unless-stopped

# =============================================================================
# NETWORKS
# =============================================================================

networks:
  ft_transcendence_network:
    driver: bridge
    name: ft_transcendence_network

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  user_data:
    driver: local
  auth_data:
    driver: local
  elasticsearch_data:
    driver: local
  logstash_data:
    driver: local
